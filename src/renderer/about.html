<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>About ClashFox</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="about.css" />
  </head>
  <body>
    <div class="about-container">
      <div class="about-title">About ClashFox</div>
      <button class="close-btn" id="closeBtn" aria-label="Close">âœ•</button>
      <div class="about-content">
        <img class="logo" src="../../assets/logo.png" alt="ClashFox logo" />
        <div class="name">ClashFox-<span id="version">0.0.0</span></div>
        <div class="meta">By ClashFox Team</div>
      </div>
    </div>
    <script>
      const { ipcRenderer } = require('electron');
      const SETTINGS_KEY = 'clashfox-settings';

      let lastSystemDark = window.matchMedia
        ? window.matchMedia('(prefers-color-scheme: dark)').matches
        : true;

      function resolveTheme(preference) {
        if (preference !== 'auto') {
          return preference;
        }
        return lastSystemDark ? 'night' : 'day';
      }

      function applyThemePreference(preference) {
        document.body.dataset.theme = resolveTheme(preference);
      }

      function readThemePreference() {
        try {
          const raw = localStorage.getItem(SETTINGS_KEY);
          if (!raw) {
            return 'auto';
          }
          const parsed = JSON.parse(raw);
          return parsed && parsed.themePreference ? parsed.themePreference : 'auto';
        } catch {
          return 'auto';
        }
      }

      function syncThemeFromSettings() {
        applyThemePreference(readThemePreference());
      }

      const mediaQuery = window.matchMedia
        ? window.matchMedia('(prefers-color-scheme: dark)')
        : null;

      if (mediaQuery) {
        mediaQuery.addEventListener('change', (event) => {
          lastSystemDark = Boolean(event.matches);
          if (readThemePreference() === 'auto') {
            applyThemePreference('auto');
          }
        });
      }

      ipcRenderer.on('clashfox:systemTheme', (_event, payload) => {
        if (!payload || typeof payload.dark !== 'boolean') {
          return;
        }
        lastSystemDark = payload.dark;
        if (readThemePreference() === 'auto') {
          applyThemePreference('auto');
        }
      });

      window.addEventListener('storage', (event) => {
        if (event.key === SETTINGS_KEY) {
          syncThemeFromSettings();
        }
      });

      syncThemeFromSettings();

      ipcRenderer.invoke('clashfox:appInfo').then((res) => {
        if (res && res.ok && res.data) {
          const version = res.data.version || '0.0.0';
          const buildNumber = res.data.buildNumber;
          const suffix = buildNumber ? `(${buildNumber})` : '';
          document.getElementById('version').textContent = `${version}${suffix}`;
        }
      });
      document.getElementById('closeBtn').addEventListener('click', () => {
        window.close();
      });
      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          window.close();
        }
      });
    </script>
  </body>
</html>
